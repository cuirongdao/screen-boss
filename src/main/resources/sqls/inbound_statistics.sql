SELECT CASE WHEN ACD_CALLS = 0 THEN 0 ELSE trunc(100.00 * ANS_CALLS / ACD_CALLS, 2) END AS ANS_CALL_RATE, ACD_CALLS AS IN_CALLS, ANS_CALLS
FROM (
	SELECT SUM(CASE WHEN CALLTYPE = 0
		AND SELECTED > 0 THEN 1 ELSE 0 END) AS ACD_CALLS, SUM(CASE WHEN ANSWERED > 0 THEN 1 ELSE 0 END) AS ANS_CALLS
	FROM (
		SELECT M.CALLTYPE AS CALLTYPE, (
				SELECT COUNT(*)
				FROM WGS_ExtensionPhase
				WHERE UCID = M.UCID
					AND ANSWERTIME IS NOT NULL
					AND ExtensionNo >= ?
					AND ExtensionNo <= ?
				) AS ANSWERED, (
				SELECT COUNT(*)
				FROM WGS_ExtensionPhase
				WHERE UCID = M.UCID
					AND ExtensionNo >= ?
					AND ExtensionNo <= ?
				) AS SELECTED
		FROM WGS_MainCDR M
		WHERE 1 = 1
			AND STARTTIME > TRUNC(SYSDATE)
			AND CALLTYPE = 0
	) T
) T2